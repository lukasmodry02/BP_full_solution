# syntax=docker/dockerfile:1

# -----------------------------
# CONFIG
# -----------------------------
ARG DOTNET_VERSION=8.0
ARG EMGU_VERSION=4.8.0
ARG UBUNTU_VERSION=22.04

# -----------------------------
# STAGE 1: EMGU BUILD
# -----------------------------
FROM ubuntu:${UBUNTU_VERSION} AS emgu_builder

ARG EMGU_VERSION=4.8.0 
# Must be repeated inside this stage!

ENV LC_ALL=C.UTF-8 LANG=C.UTF-8

RUN apt-get update && apt-get install -y --no-install-recommends \
    wget git cmake build-essential ca-certificates \
    protobuf-compiler ffmpeg \
    libgtk-3-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
    libavcodec-dev libswscale-dev libavformat-dev \
    libv4l-dev ocl-icd-opencl-dev libgeotiff-dev \
    libusb-1.0-0-dev libdc1394-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone EmguCV repository at specific version
WORKDIR /emgucv_src
RUN git config --global http.postBuffer 524288000
RUN git clone --depth 1 --branch ${EMGU_VERSION} https://github.com/emgucv/emgucv .

# Initialize submodules
WORKDIR /emgucv_src/emgucv
RUN git submodule update --init --recursive --depth 1

# Move into correct platform folder and run setup
WORKDIR /emgucv_src/emgucv/platforms/ubuntu/${UBUNTU_VERSION}
RUN chmod +x ./apt_install_dependency && ./apt_install_dependency
RUN ./cmake_configure

# Build native libs
WORKDIR /emgucv_src/emgucv/build_ubuntu
RUN cmake --build . --parallel $(nproc)

# -----------------------------
# STAGE 2: .NET BUILD
# -----------------------------
FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}-jammy AS build

WORKDIR /src

COPY ChessNotationsGenerator/ChessNotationsGenerator.csproj ChessNotationsGenerator/
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet restore ChessNotationsGenerator/ChessNotationsGenerator.csproj

COPY ChessNotationsGenerator/ ChessNotationsGenerator/
WORKDIR /src/ChessNotationsGenerator

RUN dotnet publish ChessNotationsGenerator.csproj -c Release -o /app/publish /p:UseAppHost=false

# -----------------------------
# STAGE 3: RUNTIME
# -----------------------------
FROM mcr.microsoft.com/dotnet/aspnet:${DOTNET_VERSION}-jammy AS final

WORKDIR /app

# Install runtime dependencies for EmguCV + OpenCV
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgtk-3-0 libgstreamer1.0-0 libgstreamer-plugins-base1.0-0 \
    libavcodec58 libswscale5 libavformat58 \
    libv4l-0 ocl-icd-opencl-dev \
    libgeotiff5 libusb-1.0-0 libdc1394-25 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy published .NET application
COPY --from=build /app/publish .

# Copy EmguCV native libraries
COPY --from=emgu_builder /emgucv_src/emgucv/build_ubuntu/lib/cvextern.so .
COPY --from=emgu_builder /emgucv_src/emgucv/build_ubuntu/lib/libopencv_*.so* .

# Make sure native libs can be loaded
ENV LD_LIBRARY_PATH=/app:$LD_LIBRARY_PATH

# Optional upload folder setup
RUN mkdir -p /app/wwwroot/uploads && chmod -R 777 /app/wwwroot/uploads

EXPOSE 8080

ENTRYPOINT ["dotnet", "ChessNotationsGenerator.dll"]
